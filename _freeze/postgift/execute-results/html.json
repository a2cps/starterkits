{
  "hash": "1314422c09aa359f241aa109f068aa18",
  "result": {
    "engine": "knitr",
    "markdown": "# ICA Connectivity {#sec-postgift}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readr)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(duckplyr)\nlibrary(fs)\nlibrary(tidyr)\nlibrary(ggdist)\n```\n:::\n\n\nThe @sec-gift products provide outputs in a raw format that will be familiar to users of that library. To facilitate analyses, A2CPS has repackaged those products into a tabular format. This kit covers the repackaged structure.\n\n## Starting Project\n\n### Locate Data\n\nOn TACC, the neuroimaging data are stored underneath the releases. For example, data release v2.#.# is underneath\n\n```bash\npre-surgery/mris\n```\n\n\nThe MRIQC metrics are underneath `derivatives/postgift`. Let's take a look.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n$ ls postgift\namplitude  amplitude.json  biomarkers  biomarkers.json  connectivity  connectivity.json\n```\n:::\n\n\n### Extract Data\n\nThe tabular data comprise [parquet files](https://parquet.apache.org/) that have been partitioned in a [hive style](https://hive.apache.org/). Each table is a different summary of the components derived from GIFT.\n\n- [amplitude](https://github.com/a2cps/snapshot/blob/main/src/snapshot/data/gift_amplitude.json): a measure of component amplitudes. In particular, they are the fractional Amplitude of Low Frequency Fluctuations [@zou_improved_2008].\n- [connectivity](https://github.com/a2cps/snapshot/blob/main/src/snapshot/data/gift_connectivity.json): the (product-moment) correlations between component timecourses.\n- [biomarkers](https://github.com/a2cps/snapshot/blob/main/src/snapshot/data/gift_biomarkers.json): putative biomarkers of chronic pain calculated for A2CPS analyses.\n\nLet's take a look at just the amplitudes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\namplitude <- read_parquet_duckdb(\n  dir_ls(\n    \"data/postgift/amplitude\",\n    recurse = TRUE,\n    glob = \"*parquet\"\n  ),\n  prudence = \"lavish\"\n)\n\nhead(amplitude)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|     fALFF| component|   sub|ses |task | run|model |\n|---------:|---------:|-----:|:---|:----|---:|:-----|\n|  2.061823|         0| 10003|V1  |rest |   1|2.0   |\n| 18.220871|         1| 10003|V1  |rest |   1|2.0   |\n|  2.286946|         2| 10003|V1  |rest |   1|2.0   |\n|  9.823509|         3| 10003|V1  |rest |   1|2.0   |\n|  1.624792|         4| 10003|V1  |rest |   1|2.0   |\n|  1.383541|         5| 10003|V1  |rest |   1|2.0   |\n\n</div>\n:::\n:::\n\n\nTo get a feel for the data, let's see whether there are differences between the amplitudes in the REST1 and CUFF1 scans.\n\nFirst, we filter the table, keeping only the amplitudes from a single model. We'll also convert the components into a factor, for later use during modeling. At this point, the dataset is small enough that it's easy to handle in memory, and so we'll also [collect](https://dplyr.tidyverse.org/reference/compute.html) it. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nrun1_amplitudes <- amplitude |>\n  filter(model == \"2.1\", run == 1) |>\n  select(-model, -run, -ses) |>\n  collect() |>\n  mutate(component = factor(component))\n\nhead(run1_amplitudes)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|    fALFF|component |   sub|task |\n|--------:|:---------|-----:|:----|\n| 1.215915|0         | 10003|cuff |\n| 5.390841|1         | 10003|cuff |\n| 2.573948|2         | 10003|cuff |\n| 2.491914|3         | 10003|cuff |\n| 1.392216|4         | 10003|cuff |\n| 1.952687|5         | 10003|cuff |\n\n</div>\n:::\n:::\n\n\nTo get a very high-level overview of the data, generate the [MA plot](https://en.wikipedia.org/wiki/MA_plot). Let's exclude the \"red\" scans to determine whether those are driving the difference.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nred_run1_scans <- read_tsv(dir_ls(\"data/scans\", glob = \"*tsv\"), na = \"n/a\") |>\n  filter(rating == \"red\", stringr::str_detect(filename, \"cuff_run-0[12]\")) |>\n  mutate(\n    sub = stringr::str_extract(filename, \"[[:digit:]]{5}\") |> as.integer()\n  ) |>\n  select(sub)\n```\n:::\n\n\n::: {#fig-falff}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndo_ma_plot <- function(.d) {\n  .d |>\n    pivot_wider(names_from = task, values_from = fALFF) |>\n    na.omit() |> # not every participant has a REST1 and CUFF1\n    mutate(a = (log2(rest) + log2(cuff)) / 2, m = log2(cuff) - log2(rest)) |>\n    ggplot(aes(x = a, y = m)) +\n    facet_wrap(~component, scales = \"free\", nrow = 15) +\n    geom_point(alpha = 0.2) +\n    geom_hline(yintercept = 0, color = \"blue\") +\n    geom_smooth(method = \"lm\", color = \"red\") +\n    xlab(\"Average Log Intensity\") +\n    ylab(\"CUFF1 - REST1 Log Intensities\") +\n    theme(strip.background = element_blank(), strip.text = element_blank())\n}\n\nrun1_amplitudes_without_red <- run1_amplitudes |>\n  anti_join(red_run1_scans, by = join_by(sub))\n\nrun1_amplitudes |> do_ma_plot()\n```\n\n::: {.cell-output-display}\n![](postgift_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nFractional Amplitude of Low Frequency Fluctuations. Each panel is a distinct component. The x-axis is a mean average, and the y-axis is a ratio of the two fALFFs. The \n\n:::\n\nFor the most part, there is not a substantially large difference in the log intensities. However, it may be interesting that there appears to be a trend such that amplitudes are somewhat lower in the CUFF as compared to REST conditions. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlme4::lmer(\n  log(fALFF) ~ task + (1 | sub) + (1 | component),\n  run1_amplitudes_without_red\n) |>\n  summary()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML ['lmerMod']\nFormula: log(fALFF) ~ task + (1 | sub) + (1 | component)\n   Data: run1_amplitudes_without_red\n\nREML criterion at convergence: 426430.9\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-5.4681 -0.6343  0.0154  0.6551  5.6997 \n\nRandom effects:\n Groups    Name        Variance Std.Dev.\n sub       (Intercept) 0.4852   0.6966  \n component (Intercept) 0.5847   0.7647  \n Residual              0.6963   0.8344  \nNumber of obs: 170100, groups:  sub, 943; component, 105\n\nFixed effects:\n            Estimate Std. Error t value\n(Intercept) 0.560178   0.078077   7.175\ntaskrest    0.114274   0.004422  25.843\n\nCorrelation of Fixed Effects:\n         (Intr)\ntaskrest -0.036\n```\n\n\n:::\n:::\n\n\nSo, indeed, there is some evidence for higher amplitudes during REST1 as compared with CUFF1. Please note that a more careful analysis should include other factors like scanning site, participant age, or motion. \n\n## Considerations While Working on the Project\n\n### Variability Across Scanners\n\nMany MRI biomarkers exhibit variability across the scanners, which may confound some analyses. For an up-to-date assessment of the issue and overview of current thinking, please see [Confluence](https://a2cps.atlassian.net/wiki/spaces/DOC/pages/176619539/Imaging+Harmonization). \n\n\n### Data Quality\n\nAs with any MRI derivative, all pipeline derivatives have been included. This means that products were included regardless of their quality, and so some products may have been generated from images that are known to have poor quality---rated \"red\", or incomparable. For details on the ratings and how to exclude them, see @sec-rawdata-mri-qc-joining. Additionally, extensive QC has not yet been performed on the derivatives themselves, and so there may be cases where pipelines produced atypical outputs. For an overview of planned checks, see [Confluence](https://a2cps.atlassian.net/wiki/spaces/DOC/pages/262471688/Image+Processing+Checks). \n\n\n### Citations\n\nIf you use these products in your analyses, please cite the relevant papers written by members [TReNDS](https://trendscenter.org/data/).\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}