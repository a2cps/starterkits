# FreeSurfer Measures {#sec-freesurfer}

## Starting Project

This kit will use both `shell` and `R`

```{r}
library(readr)
library(dplyr)
library(tidyr)
```


### Locate data

In the release folder, data are stored underneath the `mris/derivatives` folder:

```{bash}
#| eval: false
/corral-secure/projects/A2CPS/products/consortium-data/pre-surgery/mris/derivatives/freesurfer
```

This folder contains all of the FreeSurfer outputs for every participant (e.g., this is the directory that could correspond to the FreeSurfer environment variable `$SUBJECTS_DIR`), which subject folders of the form `sub-[recordid]_ses-[protocolid]`.

Most users will not need the raw FreeSurfer outputs and can instead rely on tables in which the morphological measures have been aggregated. There are three relevant tables

- aparc.tsv has the outputs of [`aparcstats2table`](https://surfer.nmr.mgh.harvard.edu/fswiki/aparcstats2table) (this is measurements derived from parcellations of the cortical surface, like cortical thickness)
- aseg.tsv has the outputs of [`asegstats2table`](https://surfer.nmr.mgh.harvard.edu/fswiki/asegstats2table) (that is, measurements derived from segmentations of the 3d structural image, like regional gray matter volumes)
- headers.tsv has some other information about the brain as a whole (e.g., estimated Total Intracranial Volume)

For each of these, there are data dictionaries that details the contents (e.g., `aparc.json` explains the columns of `aparc.tsv`). 

```{bash}
#| eval: false
$ ls /corral-secure/projects/A2CPS/products/consortium-data/pre-surgery/mris/derivatives/freesurfer/*{json,tsv}
/corral-secure/projects/A2CPS/products/consortium-data/pre-surgery/mris/derivatives/freesurfer/aparc.json  /corral-secure/projects/A2CPS/products/consortium-data/pre-surgery/mris/derivatives/freesurfer/gm_morph.tsv
/corral-secure/projects/A2CPS/products/consortium-data/pre-surgery/mris/derivatives/freesurfer/aparc.tsv   /corral-secure/projects/A2CPS/products/consortium-data/pre-surgery/mris/derivatives/freesurfer/headers.json
/corral-secure/projects/A2CPS/products/consortium-data/pre-surgery/mris/derivatives/freesurfer/aseg.json   /corral-secure/projects/A2CPS/products/consortium-data/pre-surgery/mris/derivatives/freesurfer/headers.tsv
/corral-secure/projects/A2CPS/products/consortium-data/pre-surgery/mris/derivatives/freesurfer/aseg.tsv
```


### Extract data

In this kit, we will consider the cortical surface measurements, stored within `aparc.tsv`. This table contains nine regional measurements for the various structures that compose each of six parcellations.

```{r}
aparc <- read_tsv("data/aparc.tsv", show_col_types = FALSE)
head(aparc)
```


A typical analysis will only rely on one parcellation. For details of the different parcellations, see the [FreeSurfer documentation](https://surfer.nmr.mgh.harvard.edu/fswiki/CorticalParcellation). Two good starting choices are either the `aparc` or `aparc.a2009s` atlas. 


```{r}
a2009s <- aparc |>
  filter(parc == "aparc.a2009s")
head(a2009s)
```

Some analyses may benefit from having the data in a "wider" format, which can be achieved with [tools from the Tidyverse](https://r4ds.hadley.nz/data-tidy.html#widening-data). For example, here is how we could pivot the table such that one column represents the participant and the others give the average cortical thickness for each region.

```{r}
a2009s_wider <- a2009s |>
  select(StructName, ThickAvg, sub, hemisphere) |>
  pivot_wider(names_from = c(StructName, hemisphere), values_from = ThickAvg)
head(a2009s_wider)
```

## Considerations While Working on the Project

### Variability Across Scanners

{{< include _snippets/mri-scanner-variability.qmd >}}

### Data Quality

{{< include _snippets/mri-qc.qmd >}}

Currently, no QC has been performed on the underlying segmentations and parcellations. With adequate sample sizes, results based on whole-atlas FreeSurfer measurements are generally robust, although there are individual regions that may warrant close inspection (e.g., [McCarthy et al. 2015](http://dx.doi.org/10.3389/fnins.2015.00379), [Vahermaa et al. 2023](https://doi.org/10.1016/j.neuroimage.2023.120306)). Moreover, it remains unclear the extent to which FreeSurfer's accuracy persists over the wide range of demographics found in the A2CPS dataset. The Imaging DIRC is actively exploring these aspects of quality. 

### Methods

FreeSurfer outputs were generated by the [fMRIPrep pipeline](https://fmriprep.org/en/stable/workflows.html#surface-preprocessing). The fMRIPrep pipeline is similar to a typical call to FreeSurfer's `recon-all`, with a majority of changes aiming to parallelize more parts of `recon-all`. However, there are differences, such as in how the brain is masked. The A2CPS use of fMRIPrep is even more different because it entails replacing the fMRIPrep masking procedure with [`SynthStrip`](https://surfer.nmr.mgh.harvard.edu/docs/synthstrip/). In general, these changes are expected to only improve the quality of the FreeSurfer outputs. However, they may hinder some comparisons between results derived from A2CPS and those in other studies.

### Citations

The FreeSurfer package has been developed through extensive research. If you use these derivatives in your analyses, please follow the documentation for citing FreeSurfer: https://surfer.nmr.mgh.harvard.edu/fswiki/FreeSurferMethodsCitation.

{{< include _snippets/a2cps_citations.qmd >}}
